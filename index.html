<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Days+One&display=swap" as="style" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Days+One&display=swap">
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" as="style" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap">
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" as="style" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="manifest" href="manifest.json">
<!-- SDK –æ—Ç –Ø–Ω–¥–µ–∫—Å -->
<script src="https://yandex.ru/games/sdk/v2"></script>
<script src="i18n.js" defer></script>
<!-- –°–∫—Ä–∏–ø—Ç YandexSDK (—Å–º–æ—Ç—Ä–∏ –Ω–∏–∂–µ) -->
<script src="yandex-sdk.js"></script>
<link rel="icon" type="image/png" href="favicon.png">

<title data-i18n="pageTitle">–ö–æ–ª–ª–∞–ø—Å</title>

<style>
.ball-wrapper {
    position: relative;
    width: 40px;
    height: 40px;
}
.ball {
    position: relative;
    z-index: 1;
}
.mask-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 40px;
    z-index: 2;
    pointer-events: none;
}
</style>
<style>
  #darkModeToggle {
    z-index: 1000;
  }
  #toggleSwitch {
    height: 0;
    width: 0;
    visibility: hidden;
    background: #001011;
  }
  #toggleSwitch + label {
    cursor: pointer;
    text-indent: -9999px;
    width: 50px;
    height: 25px;
    background: #001011;
    display: block;
    border-radius: 500px;
    position: relative;
    transition: ease-in-out 1s;
  }
  #toggleSwitch + label:after {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 21px;
    height: 21px;
    background: #F1F2EE;
    border-radius: 90px;
    transition: 0.3s;
  }
  #toggleSwitch:checked + label {
    background: #F1F2EE;
  }
  #toggleSwitch:checked + label:after {
    left: calc(100% - 2px);
    transform: translateX(-100%);
    background: #001011;
  }

  body.dark-mode, html.dark-mode {
    background: #001011 !important;
    color: #f0f0f0 !important;
  }

  body.dark-mode #container {
    background: #001011 !important;
  }
  body.dark-mode #board {
    background: #001011 !important;
  }
    
  body.dark-mode #score {
    border: 1px solid #F1F2EE;
    color: #F1F2EE;
    background: #1c1c1c;
    border: none;
  }
  
  body.dark-mode #newGame {
    background-image: url('icons/ng_wt.svg');
      
  }
    
  body.dark-mode #help-button {
    background-image: url('icons/help_wt.svg');
  }
    
  body.dark-mode #lang-selector {
  outline: none;
  font-weight: 700;
  height: 25px;
  width: 105px;
  font-family: Nunito;
  color: #F1F2EE;
  font-size: 16px;
  border-radius: 50px;
  background-color: #001011;
  border: 1px solid #363537;
  border: none;
  cursor: pointer;
}
  body.dark-mode .lang-icon {
  width: 25px;
  height: 25px;
  margin-right: 10px;
  background-image: url('icons/lang_2wt.svg')
}
  body.dark-mode #score-wrapper {
  align-items: center;
  color: #F1F2EE;
  background: #1c1c1c;
  border: none;
} 
  
</style>

<style>

#newGame {
  margin-right: 10px;
  height: 50px;
  width: 50px;
  background: none;
  border:none;
  background-image: url('icons/ng.svg');
  cursor: pointer;
  z-index: 1000;
}
        
#help-button {
/*  margin-right: 210px;*/
  margin-right: 10px;
  height: 50px;
  width: 50px;
  background: none;
  border:none;
  background-image: url('icons/help.svg');
  cursor: pointer;
  z-index: 1000;
  border: none;
}
    
#changeColorsBtn {
  margin-right: 10px;
  height: 50px;
  width: 50px;
  background: none;
  border:none;
  background-image: url('icons/theme.svg');
  cursor: pointer;
  z-index: 1000;
  border: none;
}

#help-popup {
  font-size: clamp(14px, 2.5vw, 24px);
  min-width: 233px;
  width: fit-content;
  border: 1px solid #555;
  display: none;
  position: fixed;
  border: 1px solid #555;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #222;
  color: #eee;
  border: none;
  border-radius: 10px;
  padding: 40px;
  z-index: 2000;
}
.help-content h2 {
  margin-top: 0;
  font-family: Days One;
  font-weight: 400;
  color: #fff;
  font-size: 30px;
}
.help-content ul {
  margin: 0;
  font-family: Nunito;
  padding-left: 20px;
  margin-bottom: 20px;
}
.help-content button {
  margin-top: 12px;
  padding: 10px;
  font-size: 14px;
  font-weight: 700;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.1s;
}
.help-content button:hover {
  background: #666;
}
</style>
<link href="style.css" rel="stylesheet"/>
</head>
<body>
<div id="splash-screen">
 <div class="splash-logo" data-i18n="splashLogoTitle" data-i18n-attr="title">–ö–û–õ–õ–ê–ü–°</div>
  <div class="splash-loader"></div>
</div>
<body oncontextmenu="return false">


    
<!--
<div class="lang-select-wrapper">

<div id="lang-container">
  <div class='lang-icon'></div>
  <select id="lang-selector" title="Change language">
    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
    <option value="en">English</option>
  </select>
</div>
</div>
-->

    
<div id="overlay"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã —Ç–µ—Å—Ç -->   
<!--
<button id="force-end" style="position: absolute; top: 10px; right: 10px; z-index: 3000;">
–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É
</button>
-->
<!-- –ö–Ω–æ–ø–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã —Ç–µ—Å—Ç -->
<div id="game-scaler">
<div id="game-wrapper">
<div id="container">
   <nav id="menu-buttons">
       <button id="newGame" data-i18n="newGameTitle" data-i18n-attr="title" title="–ù–æ–≤–∞—è –∏–≥—Ä–∞"></button>
       <button id="help-button" data-i18n="helpButtonTitle" data-i18n-attr="title" title="–°–ø—Ä–∞–≤–∫–∞"></button>
       <button id="changeColorsBtn" data-i18n="changeColorButtonTitle" data-i18n-attr="title" title="–°–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞"></button>
       <button class="right" id="dropBlocksBtn" data-i18n="dropBlockBtnTitle" data-i18n-attr="title"><span id="dropCounter">5</span></button>
       <button id="repaintBtn" data-i18n="repaintBtnTitle" data-i18n-attr="title"><svg id="cancelRepaint" viewBox="0 0 24 24" width="32" height="32"
     style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            cursor: pointer; z-index: 2;">
  <circle cx="12" cy="12" r="11" fill="#F24236" stroke="#333" stroke-width="2"/>
  <line x1="8" y1="8" x2="16" y2="16" stroke="#333" stroke-width="2"/>
  <line x1="16" y1="8" x2="8" y2="16" stroke="#333" stroke-width="2"/>
           </svg><span id="repaintCounter">3</span></button>
       
       
       
<!--
       <div id="darkModeToggle">
           <input id="toggleSwitch" type="checkbox"/>
           <label for="toggleSwitch"></label>
           </div>
-->
   </nav>
  <div id="score-wrapper"><span id="score">0</span></div>
  <div id="board"></div>
</div>
</div>
</div>
<script>
function scaleGameWrapper() {
  const baseWidth = 410;
  const baseHeight = 760;

  const scale = Math.min(
    window.innerWidth / baseWidth,
    window.innerHeight / baseHeight
  );

  const scaler = document.getElementById('game-scaler');
  scaler.style.transform = `translate(-50%, -50%) scale(${scale})`;
}

window.addEventListener('resize', scaleGameWrapper);
window.addEventListener('load', scaleGameWrapper);
</script>
<!--
<style>
#orientation-lock {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: #000;
  color: white;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-size: 24px;
  text-align: center;
  padding: 20px;
}
</style>
-->

<!--
<div id="orientation-lock">–ü–æ–≤–µ—Ä–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ<br>–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã</div>

<script>
function checkOrientation() {
  const lock = document.getElementById('orientation-lock');
  if (window.innerWidth > window.innerHeight) {
    lock.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –∞–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
  } else {
    lock.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
  }
}
window.addEventListener('resize', checkOrientation);
window.addEventListener('load', checkOrientation);
</script>
-->


<script>
const colorSchemes = [
  ["#F45D01", "#97CC04", "#2D7DD2", "#EEB902", "#68B0AB"],  // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ü–≤–µ—Ç–Ω–∞—è
  ["#565554", "#2E86AB", "#F6F5AE", "#F5F749", "#F24236"],  // –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä
  ["#EE6352", "#08B2E3", "#EFE9F4", "#57A773", "#484D6D"],  // –ü–ª–∞—Å—Ç–∏–ª–∏–Ω
  ["#2A2D34", "#009DDC", "#F26430", "#6761A8", "#009B72"],  // –ì—Ä–∏–Ω–≥–æ
  ["#006E90", "#F18F01", "#ADCAD6", "#99C24D", "#41BBD9"],  // –°–ø–æ—Ä—Ç–∫–∞—Ä
  ["#E6C229", "#F17105", "#D11149", "#6610F2", "#1A8FE3"],  // –ú–µ–º—Ñ–∏—Å
  ["#FF595E", "#FFCA3A", "#8AC926", "#1982C4", "#6A4C93"],  // –¶–≤–µ—Ç–Ω—ã–µ –º–µ–ª–∫–∏
  ["#272727", "#FED766", "#009FB7", "#696773", "#EFF1F3"],  // –û—Å–µ–Ω–Ω–∏–π –≤–µ—á–µ—Ä
  ["#403F4C", "#E84855", "#F9DC5C", "#3185FC", "#EFBCD5"]   // –ü–∞—Å—Ç–µ–ª—å
];

window.colors = colorSchemes[0];
let currentColorIndex = 0;
const rows = 13, cols = 9, cellSize = 42;
const board = [];
let score = 0;

const boardEl = document.getElementById('board');
boardEl.addEventListener("mouseleave", clearHighlights);
const scoreEl = document.getElementById('score');
document.getElementById("newGame").onclick = () => init();

function init() {
  boardEl.innerHTML = "";
  board.length = 0;
  score = 0;
  scoreEl.textContent = "0";
  boardEl.style.width = `${cols * cellSize}px`;
  boardEl.style.height = `${rows * cellSize}px`;

  createBoard();
  positionAll();

  // –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
  dropUses = maxDropUses;
  repaintUses = maxRepaintUses;
  updateDropButtonState();
  updateRepaintButtonState();
}

// üü© –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏
function createBoard() {
  for (let y = 0; y < rows; y++) {
    board[y] = [];
    for (let x = 0; x < cols; x++) {
      const colorIndex = Math.floor(Math.random() * colors.length);
      const div = document.createElement("div");
      div.className = "cell";
      div.style.backgroundColor = colors[colorIndex];
      div.dataset.x = x;
      div.dataset.y = y;
      board[y][x] = { colorIndex, div };
      boardEl.appendChild(div);
      div.addEventListener("mouseenter", handleHover);
      div.addEventListener("click", handleClick);
    }
  }
}

// üé® –°–º–µ–Ω–∞ –ø–∞–ª–∏—Ç—Ä—ã
document.getElementById("changeColorsBtn").addEventListener("click", () => {
  currentColorIndex = (currentColorIndex + 1) % colorSchemes.length;
  colors = colorSchemes[currentColorIndex];
  reapplyColors();
});

// üîÅ –ü–µ—Ä–µ–∫—Ä–∞—Å–∫–∞
function reapplyColors() {
  const oldColors = colorSchemes[(currentColorIndex - 1 + colorSchemes.length) % colorSchemes.length];
  const newColors = colors;

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const cell = board[y][x];
      if (cell) {
        const oldColor = oldColors[cell.colorIndex];
        let newIndex = newColors.indexOf(oldColor);
        if (newIndex === -1) newIndex = cell.colorIndex % newColors.length;
        cell.colorIndex = newIndex;
        cell.div.style.backgroundColor = newColors[newIndex];
      }
    }
  }
}

// üì¶ –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
function positionAll() {
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const cell = board[y][x];
      if (cell && cell.div) {
        cell.div.style.left = `${x * cellSize}px`;
        cell.div.style.top = `${y * cellSize}px`;
      }
    }
  }
}

// ‚ú® –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
function handleHover(e) {
  const x = +e.target.dataset.x;
  const y = +e.target.dataset.y;
  const group = getGroup(x, y);
  clearHighlights();
  if (group.length >= 2) {
    group.forEach(p => board[p.y][p.x].div.classList.add("highlight"));
  }
}

// ‚ùå –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
function clearHighlights() {
  document.querySelectorAll(".highlight").forEach(d => d.classList.remove("highlight"));
}

// üëÜ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
function handleClick(e) {
  const x = +e.target.dataset.x;
  const y = +e.target.dataset.y;
  const group = getGroup(x, y);
  if (group.length < 2) return;

  group.forEach(p => {
    boardEl.removeChild(board[p.y][p.x].div);
    board[p.y][p.x] = null;
  });

  score += group.length * (group.length - 1);
  scoreEl.textContent = score;

  collapse(() => {
    if (!hasMoves()) {
      setTimeout(() => showGameOver(score), 200);
    }
  });
}

// üîç –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
function getGroup(x, y) {
  const cell = board[y][x];
  if (!cell) return [];
  const color = colors[cell.colorIndex];
  const visited = Array.from({ length: rows }, () => Array(cols).fill(false));
  const group = [];
  const stack = [{ x, y }];

  while (stack.length) {
    const { x, y } = stack.pop();
    if (x < 0 || x >= cols || y < 0 || y >= rows) continue;
    if (visited[y][x]) continue;

    const currentCell = board[y][x];
    if (!currentCell) continue;
    const currentColor = colors[currentCell.colorIndex];
    if (currentColor !== color) continue;

    visited[y][x] = true;
    group.push({ x, y });
    stack.push({ x: x + 1, y }, { x: x - 1, y }, { x, y: y + 1 }, { x, y: y - 1 });
  }

  return group;
}

// üßπ –û–±—Ä—É—à–µ–Ω–∏–µ –∏ —Å–¥–≤–∏–≥
function collapse(callback) {
  for (let x = 0; x < cols; x++) {
    let pointer = rows - 1;
    for (let y = rows - 1; y >= 0; y--) {
      if (board[y][x]) {
        if (y !== pointer) {
          board[pointer][x] = board[y][x];
          board[pointer][x].div.dataset.y = pointer;
          board[y][x] = null;
        }
        pointer--;
      }
    }
  }

  let writeCol = 0;
  for (let readCol = 0; readCol < cols; readCol++) {
    if (board.some(row => row[readCol])) {
      if (writeCol !== readCol) {
        for (let y = 0; y < rows; y++) {
          board[y][writeCol] = board[y][readCol];
          if (board[y][writeCol]) {
            board[y][writeCol].div.dataset.x = writeCol;
          }
          board[y][readCol] = null;
        }
      }
      writeCol++;
    }
  }

  for (let x = writeCol; x < cols; x++) {
    for (let y = 0; y < rows; y++) {
      board[y][x] = null;
    }
  }

  // ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è: –≤—ã–∑–≤–∞—Ç—å positionAll —á–µ—Ä–µ–∑ –¥–≤–∞ requestAnimationFrame
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      positionAll();
      if (callback) setTimeout(callback, 300);
    });
  });
}


// ‚ùì –ï—Å—Ç—å –ª–∏ –µ—â—ë —Ö–æ–¥—ã?
function hasMoves() {
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const cell = board[y][x];
      if (!cell) continue;
      const currentColor = colors[cell.colorIndex];
      for (const [dx, dy] of [[1, 0], [0, 1]]) {
        const nx = x + dx, ny = y + dy;
        if (nx < cols && ny < rows) {
          const neighbor = board[ny][nx];
          if (neighbor && colors[neighbor.colorIndex] === currentColor) {
            return true;
          }
        }
      }
    }
  }
  return false;
}
    
    


// ‚ùó –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –≤–Ω–µ —è—á–µ–µ–∫
boardEl.addEventListener("mousemove", (e) => {
  const target = e.target;
  if (!target.classList.contains("cell")) {
    clearHighlights();
  }
});
boardEl.addEventListener("touchmove", (e) => {
  const touch = e.touches[0];
  const target = document.elementFromPoint(touch.clientX, touch.clientY);
  if (!target || !target.classList.contains("cell")) {
    clearHighlights();
  }
});

init();
</script>

<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
const maxDropUses = 5;
const maxRepaintUses = 3;
let dropUses = maxDropUses;
let repaintUses = maxRepaintUses;

const dropBtn = document.getElementById("dropBlocksBtn");
const repaintBtn = document.getElementById("repaintBtn");

function updateDropButtonState() {
  const counter = document.getElementById("dropCounter");
  dropBtn.disabled = dropUses <= 0;
  dropBtn.classList.toggle("disabled", dropUses <= 0);
  counter.textContent = dropUses;
  counter.style.background = dropUses <= 0 ? "#F24236" : "";
}

function updateRepaintButtonState() {
  const counter = document.getElementById("repaintCounter");
  repaintBtn.disabled = repaintUses <= 0;
  repaintBtn.classList.toggle("disabled", repaintUses <= 0);
  counter.textContent = repaintUses;
  counter.style.background = repaintUses <= 0 ? "#F24236" : "";
}

// –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
updateDropButtonState();
updateRepaintButtonState();

// –î–æ–±–∞–≤–∏—Ç—å 7 —Å–ª—É—á–∞–π–Ω—ã—Ö –±–ª–æ–∫–æ–≤
dropBtn.addEventListener("click", () => {
  if (dropUses <= 0) return;

  const emptyCells = [];
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      if (!board[y][x]) emptyCells.push({ x, y });
    }
  }

  if (emptyCells.length === 0) return;

  shuffleArray(emptyCells);
  const toAdd = Math.min(7, emptyCells.length);
  for (let i = 0; i < toAdd; i++) {
    const { x, y } = emptyCells[i];
    const colorIndex = Math.floor(Math.random() * colors.length);
    const div = document.createElement("div");
    div.className = "cell";
    div.style.backgroundColor = colors[colorIndex];
    div.dataset.x = x;
    div.dataset.y = y;
    board[y][x] = { colorIndex, div };
    boardEl.appendChild(div);
    div.addEventListener("mouseenter", handleHover);
    div.addEventListener("click", handleClick);
  }

  positionAll();
  collapse();

  dropUses--;
  updateDropButtonState();
});

// –ü–µ—Ä–µ–∫—Ä–∞—Å–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–∫
let repaintSelected = null;

const cancelRepaintIcon = document.getElementById("cancelRepaint");

function cancelRepaint() {
  repaintSelected = null;
  repaintBtn.classList.remove("active");
  dropBtn.disabled = dropUses <= 0;
  clearHighlighting();
  cancelRepaintIcon.style.display = "none";
}

repaintBtn.addEventListener("click", () => {
  if (repaintUses <= 0) return;

  // –ï—Å–ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –æ—Ç–∫–ª—é—á–∞–µ–º
  if (repaintSelected) {
    cancelRepaint();
    return;
  }

  // –ò–Ω–∞—á–µ ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º
  repaintSelected = true;
  repaintBtn.classList.add("active");
  dropBtn.disabled = true;
  cancelRepaintIcon.style.display = "block";

  highlightSingletons();
});

// –í—ã–¥–µ–ª–∏—Ç—å –æ–¥–∏–Ω–æ—á–Ω—ã–µ –±–ª–æ–∫–∏, –∑–∞—Ç–µ–º–Ω–∏–≤ –≥—Ä—É–ø–ø—ã
function highlightSingletons() {
  const visited = Array.from({ length: rows }, () => Array(cols).fill(false));
  const directions = [[0,1],[1,0],[0,-1],[-1,0]];

  function dfs(y, x, colorIndex, group) {
    visited[y][x] = true;
    group.push([y, x]);

    for (const [dy, dx] of directions) {
      const ny = y + dy;
      const nx = x + dx;
      if (
        ny >= 0 && ny < rows &&
        nx >= 0 && nx < cols &&
        !visited[ny][nx] &&
        board[ny][nx] &&
        board[ny][nx].colorIndex === colorIndex
      ) {
        dfs(ny, nx, colorIndex, group);
      }
    }
  }

  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      if (board[y][x] && !visited[y][x]) {
        const group = [];
        dfs(y, x, board[y][x].colorIndex, group);
        if (group.length > 1) {
          for (const [gy, gx] of group) {
            board[gy][gx].div.classList.add("dimmed");
          }
        }
      }
    }
  }
}

// –û—á–∏—Å—Ç–∏—Ç—å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
function clearHighlighting() {
  document.querySelectorAll(".dimmed").forEach(el => el.classList.remove("dimmed"));
}

boardEl.addEventListener("click", (e) => {
  if (!repaintSelected) return;
  const target = e.target;
  if (!target.classList.contains("cell")) return;

  const x = +target.dataset.x;
  const y = +target.dataset.y;

  if (!board[y][x]) return;

  // –í—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Ü–≤–µ—Ç –∏–∑ 4 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ä–∞–∑–Ω—ã—Ö –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
  const currentColorIndex = board[y][x].colorIndex;
  const possibleColors = [];

  for (let i = 0; i < colors.length; i++) {
    if (i !== currentColorIndex) possibleColors.push(i);
  }

  const newColorIndex = possibleColors[Math.floor(Math.random() * possibleColors.length)];
  board[y][x].colorIndex = newColorIndex;
  board[y][x].div.style.backgroundColor = colors[newColorIndex];

  repaintSelected = null;
  repaintBtn.classList.remove("active");
  dropBtn.disabled = dropUses <= 0;

  repaintUses--;
  updateRepaintButtonState();

  clearHighlighting();

  // –°–∫—Ä—ã—Ç—å –∫—Ä–µ—Å—Ç–∏–∫ –æ—Ç–º–µ–Ω—ã
  document.getElementById("cancelRepaint").style.display = "none";
});


// –£—Ç–∏–ª–∏—Ç–∞ —Ç–∞—Å–æ–≤–∞–Ω–∏—è
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function showGameOver(score) {
  alert("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Å—á—ë—Ç: " + score);
}
</script>





<script>
function closeHelp() {
  document.getElementById("help-popup").style.display = "none";
}
</script>
<!-- Help Popup -->
<div id="help-popup">
<div class="help-content">
<h2 data-i18n="title">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h2>
<p data-i18n="line1">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥—Ä—É–ø–ø—É –∫—É–±–∏–∫–æ–≤ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –∏—Ö —Å –ø–æ–ª—è.</p>
<p data-i18n="line2">–ß–µ–º –±–æ–ª—å—à–µ –≥—Ä—É–ø–ø–∞, —Ç–µ–º –±–æ–ª—å—à–µ –æ—á–∫–æ–≤:</p>
<ul data-i18n="points">
<li>2 –∫—É–±–∏–∫–∞ ‚Äî 2 –æ—á–∫–∞</li>
<li>3 ‚Äî 6 –æ—á–∫–æ–≤</li>
<li>4 ‚Äî 12 –æ—á–∫–æ–≤</li>
<li>5 ‚Äî 20 –æ—á–∫–æ–≤</li>
<li>6+ ‚Äî –ø–æ —Ñ–æ—Ä–º—É–ª–µ: N √ó (N - 1)</li>
</ul>
<div class="feature-row">
      <img src="icons/add.svg" alt="–ö–æ–ª–ª–∞–ø—Å" class="feature-icon">
      <span data-i18n="feature1">—Å–±—Ä–æ—Å–∏—Ç—å –≤–Ω–∏–∑ —Å–µ–º—å —Å–ª—É—á–∞–π–Ω—ã—Ö –∫—É–±–∏–∫–æ–≤</span>
    </div>
    
    <div class="feature-row">
      <img src="icons/paint.svg" alt="–ö—Ä–∞—Å–∫–∞" class="feature-icon">
      <span data-i18n="feature2">–ü–µ—Ä–µ–∫—Ä–∞—Å–∏—Ç—å –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫—É–±–∏–∫ –≤ —Å–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç</span>
    </div>
<button data-i18n="button" onclick="closeHelp()">–ü–æ–Ω—è—Ç–Ω–æ</button>
</div>
</div>
    
<div id="gameover-popup">
  <div class="gameover-content">
    <img src="img/gameover_3.svg" alt="Game Over" style="width: 150px; display: block; margin: 0 auto 20px;">
    <h2 id="gameOverTitle" data-i18n="gameOverTitle">–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã</h2>
    <div id="gameOverScoreWrapper">
    <div id="final-score-label" style="text-align: center; font-family: Nunito; font-size: 16px; padding-top: 10px;">–°—á—ë—Ç</div>
    <div id="final-score" style="text-align: center; font-family: Days One; font-size: 28px; font-weight: 400; padding-bottom: 10px;">0</div>
    </div>
    <div class="gameover-buttons">
    <button onclick="restartGame()" data-i18n="playAgainButton">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>
  </div>
</div>
    
<script>
document.getElementById("help-button").onclick = function () {
  document.getElementById("help-popup").style.display = "block";
};
function closeHelp() {
  document.getElementById("help-popup").style.display = "none";
}
</script>
<script src="script.js"></script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.error('Service Worker registration failed:', err));
    });
  }
</script>
<script>
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });
  });
</script>
<!--
<script>
const translations = {
  ru: {
    title: "–ö–∞–∫ –∏–≥—Ä–∞—Ç—å",
    line1: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥—Ä—É–ø–ø—É –∫—É–±–∏–∫–æ–≤ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –∏—Ö —Å –ø–æ–ª—è.",
    line2: "–ß–µ–º –±–æ–ª—å—à–µ –≥—Ä—É–ø–ø–∞, —Ç–µ–º –±–æ–ª—å—à–µ –æ—á–∫–æ–≤:",
    points: [
      "2 –∫—É–±–∏–∫–∞ ‚Äî 2 –æ—á–∫–∞",
      "3 ‚Äî 6 –æ—á–∫–æ–≤",
      "4 ‚Äî 12 –æ—á–∫–æ–≤",
      "5 ‚Äî 20 –æ—á–∫–æ–≤",
      "6+ ‚Äî –ø–æ —Ñ–æ—Ä–º—É–ª–µ: N √ó (N - 1)"
    ],
    button: "–ü–æ–Ω—è—Ç–Ω–æ",
    pageTitle: "–ö–æ–ª–ª–∞–ø—Å",
    newGameTitle: "–ù–æ–≤–∞—è –∏–≥—Ä–∞",
    helpButtonTitle: "–°–ø—Ä–∞–≤–∫–∞",
    scoreLabel: "–°—á—ë—Ç",
    gameOverTitle: "–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã",
    playAgainButton: "–ù–æ–≤–∞—è –∏–≥—Ä–∞",
  },
  en: {
    title: "How to Play",
    line1: "Click on a group of bricks of the same color to remove them from the board.",
    line2: "The larger the group, the more points you earn:",
    points: [
      "2 bricks ‚Äî 2 points",
      "3 ‚Äî 6 points",
      "4 ‚Äî 12 points",
      "5 ‚Äî 20 points",
      "6+ ‚Äî by the formula: N √ó (N - 1)"
    ],
    button: "Got it",
    pageTitle: "Collapse",
    newGameTitle: "New game",
    helpButtonTitle: "Help",
    scoreLabel: "Score",
    gameOverTitle: "Game over",
    playAgainButton: "New game",
  }
};

function updateHelpText(lang) {
  const t = translations[lang];
  document.querySelector('#help-popup h2').textContent = t.title;
  const paragraphs = document.querySelectorAll('#help-popup p');
  paragraphs[0].textContent = t.line1;
  paragraphs[1].textContent = t.line2;

  const ul = document.querySelector('#help-popup ul');
  ul.innerHTML = '';
  t.points.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ul.appendChild(li);
  });

  document.querySelector('#help-popup button').textContent = t.button;

  document.title = t.pageTitle || t.title;

  const newGameBtn = document.getElementById('newGame');
  if (newGameBtn) {
    newGameBtn.title = t.newGameTitle || "";
  }

  const helpBtn = document.getElementById('help-button');
  if (helpBtn) {
    helpBtn.title = t.helpButtonTitle || "";
  }

  const scoreLabel = document.getElementById('score-label');
  if(scoreLabel) scoreLabel.textContent = t.scoreLabel || "";
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
function applyTranslations(lang) {
  const t = translations[lang];
  if (!t) return;

  const gameOverTitle = document.getElementById('gameOverTitle');
  if (gameOverTitle) gameOverTitle.textContent = t.gameOverTitle;

  const finalScoreLabel = document.getElementById('final-score-label');
  if (finalScoreLabel) finalScoreLabel.textContent = t.scoreLabel;

  const gameOverButton = document.querySelector('#gameover-popup button');
  if (gameOverButton) gameOverButton.textContent = t.newGameTitle;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞
document.getElementById('lang-selector').addEventListener('change', function() {
  const lang = this.value;
  updateHelpText(lang);
  applyTranslations(lang);
});

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –∫–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–∞–º
const initialLang = document.getElementById('lang-selector').value;
updateHelpText(initialLang);
applyTranslations(initialLang);
</script>
-->
<script>
  async function startNewGame() {
    console.log('[Game] –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã...');
    // –¢—É—Ç –∑–∞–ø—É—Å–∫–∞–π —Å–≤–æ—é –∏–≥—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–±—Ä–æ—Å –ø–æ–ª—è, —Å—á—ë—Ç, –∏ —Ç.–¥.)
  }

  window.addEventListener('load', async () => {
    const sdkReady = await YandexSDK.init();

    if (sdkReady) {
      await YandexSDK.initPlayer();
      const lang = YandexSDK.getLanguage();
      console.log('[Game] –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', lang);
    }

    // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –∏–≥—Ä–∞"
    document.getElementById('newGame').addEventListener('click', () => {
      YandexSDK.showAd();
    });
  });
    
document.addEventListener("DOMContentLoaded", () => {
  const splash = document.getElementById("splash-screen");
  
  if (splash) {
    setTimeout(() => {
      splash.style.opacity = "0"; // –ø–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
      splash.style.pointerEvents = "none"; // –±–ª–æ–∫–∏—Ä—É–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —ç–∫—Ä–∞–Ω–æ–º
    }, 500); // –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ª–æ–≥–æ—Ç–∏–ø

    // –£–¥–∞–ª—è–µ–º —Å–ø–ª—ç—à-—ç–∫—Ä–∞–Ω –ø–æ—Å–ª–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    setTimeout(() => {
      splash.remove();
    }, 1000); // 1 —Å–µ–∫—É–Ω–¥–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
  }
});

</script>
<!--<audio id="break-sound" src="sounds/click1.wav" preload="auto"></audio>-->
</body>
</html>
